{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <h1>Create Task</h1>
    <div class="login">
      <a href="{% url 'tasks' %}">Tasks</a>
    </div>

    <div class="input-container">
        <input type="text" id="taskName" placeholder="Nazwa zadania"><br>
        <input type="text" id="taskDescription" placeholder="Opis zadania"><br>
        <select id="taskStatus">
          <option value="Nowy">Nowy</option>
          <option value="W toku">W toku</option>
          <option value="Rozwiązany">Rozwiązany</option>
        </select><br>
        <select id="assignedUserSelect">
          <option value="">-- Wybierz użytkownika --</option>
        </select><br>
        <button onclick="addTask()">Dodaj zadanie</button>
      </div>

    <script>
      window.onload = () => {
        loadUsers();
      };

      async function loadUsers() {
      const token = localStorage.getItem("usrToken");
      if (!token) return;

      try {
          const response = await fetch("/api/users/", {
              method: "GET",
              headers: {
                  "Authorization": token,
                  "Content-Type": "application/json"
              }
          });

          if (!response.ok) throw new Error("Błąd pobierania użytkowników");

          const users = await response.json();
          const userSelect = document.getElementById("assignedUserSelect");

          users.forEach(user => {
              const option = document.createElement("option");
              option.value = user.id;
              option.text = user.username;
              userSelect.appendChild(option);
          });

        } catch (err) {
            console.error("Błąd ładowania użytkowników:", err);
        }
      }
        function addTask() {
          const token = localStorage.getItem("usrToken");
          if (!token) {
            alert("Brak tokenu — zaloguj się najpierw.");
            return;
          }

          const name = document.getElementById("taskName").value;
          const description = document.getElementById("taskDescription").value;
          const status = document.getElementById("taskStatus").value;
          const assignedUser = document.getElementById("assignedUserSelect").value;

          const data = {
            nazwa: name,
            opis: description,
            status: status
          };

          if (assignedUser) {
            data.przypisany_uzytkownik = parseInt(assignedUser);
          }

          fetch("/api/tasks/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": token
            },
            body: JSON.stringify(data)
          })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((err) => {
                throw new Error(JSON.stringify(err));
              });
            }
            return response.json();
          })
          .then((data) => {
            alert("Zadanie dodane pomyślnie!");
            console.log(data);
          })
          .catch((error) => {
            console.error("Błąd przy dodawaniu zadania:", error);
            alert("Wystąpił błąd: " + error.message);
          });
        }
    </script>
</body>
</html>